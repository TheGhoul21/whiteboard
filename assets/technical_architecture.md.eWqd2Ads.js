import{_ as a,o as i,c as n,ag as t}from"./chunks/framework.BDo2gMlJ.js";const c=JSON.parse('{"title":"Architecture Overview","description":"","frontmatter":{},"headers":[],"relativePath":"technical/architecture.md","filePath":"technical/architecture.md"}'),e={name:"technical/architecture.md"};function l(p,s,h,k,r,o){return i(),n("div",null,[...s[0]||(s[0]=[t(`<h1 id="architecture-overview" tabindex="-1">Architecture Overview <a class="header-anchor" href="#architecture-overview" aria-label="Permalink to &quot;Architecture Overview&quot;">​</a></h1><p>This document provides a high-level overview of the whiteboard&#39;s technical architecture.</p><h2 id="stack" tabindex="-1">Stack <a class="header-anchor" href="#stack" aria-label="Permalink to &quot;Stack&quot;">​</a></h2><h3 id="frontend" tabindex="-1">Frontend <a class="header-anchor" href="#frontend" aria-label="Permalink to &quot;Frontend&quot;">​</a></h3><ul><li><strong>React 18</strong> - UI framework with concurrent rendering</li><li><strong>TypeScript</strong> - Type-safe JavaScript</li><li><strong>Vite</strong> - Build tool and dev server</li><li><strong>React-Konva</strong> - Canvas rendering engine (wrapper for Konva.js)</li><li><strong>Tailwind CSS</strong> - Utility-first styling</li></ul><h3 id="canvas-rendering" tabindex="-1">Canvas &amp; Rendering <a class="header-anchor" href="#canvas-rendering" aria-label="Permalink to &quot;Canvas &amp; Rendering&quot;">​</a></h3><ul><li><strong>Konva.js</strong> - High-performance 2D canvas library</li><li><strong>Perfect Freehand</strong> - Pressure-sensitive ink simulation</li><li><strong>D3.js</strong> - Data visualization in code blocks</li><li><strong>KaTeX</strong> - Math equation rendering</li><li><strong>React Syntax Highlighter</strong> - Code syntax highlighting</li></ul><h3 id="desktop" tabindex="-1">Desktop <a class="header-anchor" href="#desktop" aria-label="Permalink to &quot;Desktop&quot;">​</a></h3><ul><li><strong>Tauri v2</strong> - Rust-based desktop framework</li><li><strong>Window Management</strong> - Dual-window sync via localStorage</li></ul><h3 id="backend" tabindex="-1">Backend <a class="header-anchor" href="#backend" aria-label="Permalink to &quot;Backend&quot;">​</a></h3><ul><li><strong>Node.js + Express</strong> - Minimal REST API for board persistence</li><li><strong>File System</strong> - JSON-based board storage</li></ul><hr><h2 id="high-level-architecture" tabindex="-1">High-Level Architecture <a class="header-anchor" href="#high-level-architecture" aria-label="Permalink to &quot;High-Level Architecture&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                        Browser/Tauri                        │</span></span>
<span class="line"><span>│                                                             │</span></span>
<span class="line"><span>│  ┌───────────────────────────────────────────────────────┐ │</span></span>
<span class="line"><span>│  │                    React App                          │ │</span></span>
<span class="line"><span>│  │                                                       │ │</span></span>
<span class="line"><span>│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐│ │</span></span>
<span class="line"><span>│  │  │   Toolbar    │  │   Minimap    │  │    Frames   ││ │</span></span>
<span class="line"><span>│  │  └──────────────┘  └──────────────┘  └─────────────┘│ │</span></span>
<span class="line"><span>│  │                                                       │ │</span></span>
<span class="line"><span>│  │  ┌─────────────────────────────────────────────────┐ │ │</span></span>
<span class="line"><span>│  │  │         Whiteboard Component                    │ │ │</span></span>
<span class="line"><span>│  │  │  (React-Konva Stage)                            │ │ │</span></span>
<span class="line"><span>│  │  │                                                  │ │ │</span></span>
<span class="line"><span>│  │  │  ┌─────────────────────────────────────────┐   │ │ │</span></span>
<span class="line"><span>│  │  │  │   Objects Layer                         │   │ │ │</span></span>
<span class="line"><span>│  │  │  │   - Strokes (fountain pen, laser)       │   │ │ │</span></span>
<span class="line"><span>│  │  │  │   - Shapes (rect, circle, arrow)        │   │ │ │</span></span>
<span class="line"><span>│  │  │  │   - Text Objects                        │   │ │ │</span></span>
<span class="line"><span>│  │  │  │   - LaTeX Objects (KaTeX)               │   │ │ │</span></span>
<span class="line"><span>│  │  │  │   - Code Blocks (executable JS)         │   │ │ │</span></span>
<span class="line"><span>│  │  │  │   - D3 Visualizations (SVG→Canvas)      │   │ │ │</span></span>
<span class="line"><span>│  │  │  │   - Images (paste/upload)               │   │ │ │</span></span>
<span class="line"><span>│  │  │  └─────────────────────────────────────────┘   │ │ │</span></span>
<span class="line"><span>│  │  │                                                  │ │ │</span></span>
<span class="line"><span>│  │  │  ┌─────────────────────────────────────────┐   │ │ │</span></span>
<span class="line"><span>│  │  │  │   Spotlight Overlay (HTML)              │   │ │ │</span></span>
<span class="line"><span>│  │  │  └─────────────────────────────────────────┘   │ │ │</span></span>
<span class="line"><span>│  │  └─────────────────────────────────────────────────┘ │ │</span></span>
<span class="line"><span>│  │                                                       │ │</span></span>
<span class="line"><span>│  └───────────────────────────────────────────────────────┘ │</span></span>
<span class="line"><span>│                                                             │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────────────────┘</span></span>
<span class="line"><span>                              │</span></span>
<span class="line"><span>                              │ Auto-save (localStorage)</span></span>
<span class="line"><span>                              │ Manual save (POST /api/boards)</span></span>
<span class="line"><span>                              ▼</span></span>
<span class="line"><span>                    ┌──────────────────┐</span></span>
<span class="line"><span>                    │   Node.js API    │</span></span>
<span class="line"><span>                    │   (Express)      │</span></span>
<span class="line"><span>                    └──────────────────┘</span></span>
<span class="line"><span>                              │</span></span>
<span class="line"><span>                              ▼</span></span>
<span class="line"><span>                    ┌──────────────────┐</span></span>
<span class="line"><span>                    │   File System    │</span></span>
<span class="line"><span>                    │  (JSON boards)   │</span></span>
<span class="line"><span>                    └──────────────────┘</span></span></code></pre></div><hr><h2 id="core-components" tabindex="-1">Core Components <a class="header-anchor" href="#core-components" aria-label="Permalink to &quot;Core Components&quot;">​</a></h2><h3 id="_1-whiteboard-component-app-tsx" tabindex="-1">1. Whiteboard Component (<code>App.tsx</code>) <a class="header-anchor" href="#_1-whiteboard-component-app-tsx" aria-label="Permalink to &quot;1. Whiteboard Component (\`App.tsx\`)&quot;">​</a></h3><p><strong>Purpose</strong>: Main canvas container and state management</p><p><strong>Responsibilities</strong>:</p><ul><li>Canvas state (objects, viewport, history)</li><li>Tool state (current tool, color, stroke width)</li><li>Event handling (mouse/touch, keyboard)</li><li>Object lifecycle (create, update, delete)</li><li>Undo/redo history</li></ul><p><strong>Key State</strong>:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">objects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setObjects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WhiteboardObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]&gt;([]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">selectedIds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setSelectedIds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt;(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setTool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Tool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;pen&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">viewPos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setViewPos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ x: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, y: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">zoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setZoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">history</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setHistory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HistoryEntry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]&gt;([]);</span></span></code></pre></div><h3 id="_2-object-renderers" tabindex="-1">2. Object Renderers <a class="header-anchor" href="#_2-object-renderers" aria-label="Permalink to &quot;2. Object Renderers&quot;">​</a></h3><p>Each object type has its own React component:</p><h4 id="strokeobject-strokeobject-tsx" tabindex="-1">StrokeObject (<code>StrokeObject.tsx</code>) <a class="header-anchor" href="#strokeobject-strokeobject-tsx" aria-label="Permalink to &quot;StrokeObject (\`StrokeObject.tsx\`)&quot;">​</a></h4><ul><li>Renders ink strokes using <code>perfect-freehand</code></li><li>Variable pressure simulation</li><li>Fountain pen, highlighter, laser pointer variants</li><li>Laser fading animation (3 second decay)</li></ul><h4 id="codeblockobject-codeblockobject-tsx" tabindex="-1">CodeBlockObject (<code>CodeBlockObject.tsx</code>) <a class="header-anchor" href="#codeblockobject-codeblockobject-tsx" aria-label="Permalink to &quot;CodeBlockObject (\`CodeBlockObject.tsx\`)&quot;">​</a></h4><ul><li><strong>Most complex component</strong> (~1500 lines)</li><li>CodeMirror editor with syntax highlighting</li><li>JavaScript sandbox execution (<code>new Function</code>)</li><li>Control widgets (sliders, buttons, etc.)</li><li>D3.js visualization output</li><li>Animation system (keyframe recording/playback)</li><li><strong>Critical fixes applied</strong> (timeout, execution lock, etc.)</li></ul><h4 id="d3visualizationobject-d3visualizationobject-tsx" tabindex="-1">D3VisualizationObject (<code>D3VisualizationObject.tsx</code>) <a class="header-anchor" href="#d3visualizationobject-d3visualizationobject-tsx" aria-label="Permalink to &quot;D3VisualizationObject (\`D3VisualizationObject.tsx\`)&quot;">​</a></h4><ul><li>Renders D3.js SVG output as Konva image</li><li>SVG → Blob URL → Image → Konva.Image pipeline</li><li><strong>Blob URL lifecycle management</strong> (Fix 3)</li><li>Animation player for programmatic animations</li><li>Control panel for user interaction</li></ul><h4 id="latexobject-textobject-shapeobject-etc" tabindex="-1">LaTeXObject, TextObject, ShapeObject, etc. <a class="header-anchor" href="#latexobject-textobject-shapeobject-etc" aria-label="Permalink to &quot;LaTeXObject, TextObject, ShapeObject, etc.&quot;">​</a></h4><ul><li>Simpler renderers for static content</li><li>KaTeX rendering for math</li><li>React-Konva primitives for shapes</li></ul><h3 id="_3-code-execution-system" tabindex="-1">3. Code Execution System <a class="header-anchor" href="#_3-code-execution-system" aria-label="Permalink to &quot;3. Code Execution System&quot;">​</a></h3><p><strong>Architecture</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>User Code (JavaScript)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Timeout Guard Injection (sandboxTimeout.ts)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Sandbox Creation (20+ APIs: d3, slider, button, etc.)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>new Function() Execution</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>┌──────────────────┬──────────────────┐</span></span>
<span class="line"><span>│   Fast Path      │   Slow Path      │</span></span>
<span class="line"><span>│   (Animation)    │   (User Action)  │</span></span>
<span class="line"><span>├──────────────────┼──────────────────┤</span></span>
<span class="line"><span>│ Precompute       │ Full Execution   │</span></span>
<span class="line"><span>│ executeRender()  │ Regenerate       │</span></span>
<span class="line"><span>│ (&lt; 5ms)          │ (100-500ms)      │</span></span>
<span class="line"><span>└──────────────────┴──────────────────┘</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Output (HTML/SVG/Controls/Animations)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Create/Update D3VisualizationObject</span></span></code></pre></div><p><strong>Sandbox APIs</strong>:</p><ul><li><code>d3</code> - Full D3.js library</li><li><code>slider</code>, <code>button</code>, <code>checkbox</code>, etc. - UI controls</li><li><code>animate()</code> - Programmatic animation creation</li><li><code>precompute()</code> - Expensive computation separation</li><li><code>render()</code> - Per-frame rendering callback</li><li><code>output</code> - DOM node for visualization</li><li><code>board</code> - Access to other board objects (read-only)</li></ul><h3 id="_4-animation-system" tabindex="-1">4. Animation System <a class="header-anchor" href="#_4-animation-system" aria-label="Permalink to &quot;4. Animation System&quot;">​</a></h3><p><strong>Architecture</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Animation Recording (User):</span></span>
<span class="line"><span>  1. Click &quot;Record&quot; button</span></span>
<span class="line"><span>  2. Adjust control sliders</span></span>
<span class="line"><span>  3. Click &quot;+ KF&quot; to save keyframe</span></span>
<span class="line"><span>  4. Repeat steps 2-3</span></span>
<span class="line"><span>  5. Click &quot;Stop&quot; button</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Keyframe Storage:</span></span>
<span class="line"><span>  {</span></span>
<span class="line"><span>    id: &#39;anim-123&#39;,</span></span>
<span class="line"><span>    duration: 5,</span></span>
<span class="line"><span>    fps: 30,</span></span>
<span class="line"><span>    loop: true,</span></span>
<span class="line"><span>    keyframes: [</span></span>
<span class="line"><span>      { frame: 0, controlValues: { Steps: 0 } },</span></span>
<span class="line"><span>      { frame: 60, controlValues: { Steps: 50 } },</span></span>
<span class="line"><span>      { frame: 150, controlValues: { Steps: 100 } }</span></span>
<span class="line"><span>    ]</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Animation Playback:</span></span>
<span class="line"><span>  1. AnimationPlayer starts RAF loop</span></span>
<span class="line"><span>  2. Interpolate between keyframes</span></span>
<span class="line"><span>  3. Call onExecute(controlValues, time)</span></span>
<span class="line"><span>  4. CodeBlock fast-path: executeRender(frameIndex)</span></span>
<span class="line"><span>  5. D3Visualization updates</span></span></code></pre></div><p><strong>Components</strong>:</p><ul><li><strong>AnimationPlayer</strong> (<code>AnimationPlayer.tsx</code>) - RAF loop, interpolation</li><li><strong>PrecomputeRenderEngine</strong> (<code>PrecomputeRenderEngine.ts</code>) - Frame cache</li><li><strong>FrameCache</strong> (<code>FrameCache.ts</code>) - Interpolated data storage</li></ul><h3 id="_5-precompute-render-engine" tabindex="-1">5. Precompute/Render Engine <a class="header-anchor" href="#_5-precompute-render-engine" aria-label="Permalink to &quot;5. Precompute/Render Engine&quot;">​</a></h3><p><strong>Purpose</strong>: Separate expensive computation from per-frame rendering</p><p><strong>Problem</strong>:</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Slow - runs 30 times per second</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> step </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; step </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; step</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> expensiveComputation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(step); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 100ms!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  d3.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(output).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">append</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;circle&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">attr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;r&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Solution</strong>:</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Fast - runs ONCE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">precompute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> allData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> step </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; step </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; step</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    allData.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">expensiveComputation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(step));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allData;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Fast - runs 30 times per second</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">render</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">frame</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">allData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> allData[frame];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  d3.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(output).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">selectAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;circle&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">attr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;r&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>Implementation</strong>:</p><ul><li><code>precompute(fn)</code> - Executes once, caches result</li><li><code>render(fn)</code> - Called per frame with cached data</li><li><code>FrameCache</code> - Stores precomputed data with interpolation</li><li>Execution lock prevents race conditions (Fix 2)</li></ul><hr><h2 id="data-flow" tabindex="-1">Data Flow <a class="header-anchor" href="#data-flow" aria-label="Permalink to &quot;Data Flow&quot;">​</a></h2><h3 id="_1-drawing-flow" tabindex="-1">1. Drawing Flow <a class="header-anchor" href="#_1-drawing-flow" aria-label="Permalink to &quot;1. Drawing Flow&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>User Mouse Event</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Whiteboard.tsx (event handler)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Create StrokeObject (perfect-freehand)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Add to objects[] state</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Re-render (React)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>StrokeObject.tsx renders Konva.Line</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Konva draws to canvas</span></span></code></pre></div><h3 id="_2-code-execution-flow" tabindex="-1">2. Code Execution Flow <a class="header-anchor" href="#_2-code-execution-flow" aria-label="Permalink to &quot;2. Code Execution Flow&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>User Clicks &quot;Run&quot; Button</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>CodeBlockObject.tsx (executeCode)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Execution Queue (serialize slow-path)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Timeout Guard Injection</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Create Sandbox (d3, controls, etc.)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>new Function() execution</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Extract output (HTML/SVG)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Call onCreateVisualization()</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>App.tsx creates D3VisualizationObject</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>D3VisualizationObject renders SVG as Konva.Image</span></span></code></pre></div><h3 id="_3-animation-playback-flow" tabindex="-1">3. Animation Playback Flow <a class="header-anchor" href="#_3-animation-playback-flow" aria-label="Permalink to &quot;3. Animation Playback Flow&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>User Clicks &quot;Play&quot; Button</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>AnimationPlayer starts RAF loop</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Interpolate keyframes at currentTime</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Call onExecute(interpolatedValues, time)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>CodeBlock.executeCode() with executionContext</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Fast-path: precomputeEngine.executeRender()</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Call renderCallback(frame, cachedData, values)</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Update D3 visualization DOM</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>D3VisualizationObject detects change</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>Re-render Konva.Image</span></span>
<span class="line"><span>       ↓</span></span>
<span class="line"><span>RAF loop continues</span></span></code></pre></div><hr><h2 id="state-management" tabindex="-1">State Management <a class="header-anchor" href="#state-management" aria-label="Permalink to &quot;State Management&quot;">​</a></h2><h3 id="app-level-state-app-tsx" tabindex="-1">App-Level State (<code>App.tsx</code>) <a class="header-anchor" href="#app-level-state-app-tsx" aria-label="Permalink to &quot;App-Level State (\`App.tsx\`)&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Persisted state (auto-saved to localStorage)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fullState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setFullState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  objects: [],           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// All board objects</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  frames: [],           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Bookmarked viewports</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  animations: [],       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Global animations (deprecated)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  background: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;grid&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Background style</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  customColors: []      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// User&#39;s color palette</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// UI state (not persisted)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setTool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;pen&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setColor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;#000000&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">selectedIds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setSelectedIds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isSpotlightActive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setIsSpotlightActive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Viewport state (persisted in frames, but not in fullState)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">viewPos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setViewPos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ x: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, y: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">zoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setZoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// History (undo/redo)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">history</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setHistory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">historyIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setHistoryIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="object-level-state" tabindex="-1">Object-Level State <a class="header-anchor" href="#object-level-state" aria-label="Permalink to &quot;Object-Level State&quot;">​</a></h3><p>Each object type has its own state structure:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CodeBlockObj</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;codeblock&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  x</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  y</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  height</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  code</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  language</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  controls</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ControlWidget</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  isFolded</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  appendMode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  isRecording</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  outputId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  animationId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  executionContext</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    vizId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    controlValues</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    animationTime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lastExecuted</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  error</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h3 id="immutability-pattern" tabindex="-1">Immutability Pattern <a class="header-anchor" href="#immutability-pattern" aria-label="Permalink to &quot;Immutability Pattern&quot;">​</a></h3><p>All state updates use immutable patterns:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ADD object</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setObjects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prev</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">prev, newObject]);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// UPDATE object</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setObjects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prev</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">obj</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  obj.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">obj, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">updates } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> obj</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// DELETE object</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setObjects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prev</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prev.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">obj</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> obj.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// UPDATE with batching</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setObjects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prev</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> updated</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">prev];</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Multiple modifications</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> updated;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h2 id="performance-optimizations" tabindex="-1">Performance Optimizations <a class="header-anchor" href="#performance-optimizations" aria-label="Permalink to &quot;Performance Optimizations&quot;">​</a></h2><h3 id="_1-react-optimizations" tabindex="-1">1. React Optimizations <a class="header-anchor" href="#_1-react-optimizations" aria-label="Permalink to &quot;1. React Optimizations&quot;">​</a></h3><ul><li><strong>Memoization</strong>: <code>React.memo</code> for expensive renderers</li><li><strong>useMemo/useCallback</strong>: Prevent unnecessary re-renders</li><li><strong>Key props</strong>: Stable keys for object lists</li><li><strong>Lazy loading</strong>: Code-split heavy components</li></ul><h3 id="_2-canvas-optimizations" tabindex="-1">2. Canvas Optimizations <a class="header-anchor" href="#_2-canvas-optimizations" aria-label="Permalink to &quot;2. Canvas Optimizations&quot;">​</a></h3><ul><li><strong>Layer caching</strong>: Konva layer caching for static objects</li><li><strong>Hit detection</strong>: Custom hit regions for complex objects</li><li><strong>Viewport culling</strong>: Only render visible objects (future)</li></ul><h3 id="_3-execution-optimizations" tabindex="-1">3. Execution Optimizations <a class="header-anchor" href="#_3-execution-optimizations" aria-label="Permalink to &quot;3. Execution Optimizations&quot;">​</a></h3><ul><li><strong>Precompute/Render separation</strong>: Run expensive work once</li><li><strong>Frame caching</strong>: Cache interpolated data</li><li><strong>Execution queue</strong>: Serialize slow-path to prevent race conditions</li><li><strong>Fast-path</strong>: Direct render for animation frames (&lt;5ms)</li></ul><h3 id="_4-memory-optimizations" tabindex="-1">4. Memory Optimizations <a class="header-anchor" href="#_4-memory-optimizations" aria-label="Permalink to &quot;4. Memory Optimizations&quot;">​</a></h3><ul><li><strong>Blob URL revocation</strong>: Prevent memory leaks (Fix 3)</li><li><strong>Lazy stroke simplification</strong>: Reduce point count for old strokes</li><li><strong>History pruning</strong>: Limit undo stack size</li></ul><hr><h2 id="desktop-architecture-tauri" tabindex="-1">Desktop Architecture (Tauri) <a class="header-anchor" href="#desktop-architecture-tauri" aria-label="Permalink to &quot;Desktop Architecture (Tauri)&quot;">​</a></h2><h3 id="dual-window-system" tabindex="-1">Dual-Window System <a class="header-anchor" href="#dual-window-system" aria-label="Permalink to &quot;Dual-Window System&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌──────────────────────┐       ┌──────────────────────┐</span></span>
<span class="line"><span>│  Control Window      │       │ Presentation Window  │</span></span>
<span class="line"><span>│  (Full UI)           │       │ (Canvas Only)        │</span></span>
<span class="line"><span>│                      │       │                      │</span></span>
<span class="line"><span>│  ┌────────────────┐  │       │  ┌────────────────┐  │</span></span>
<span class="line"><span>│  │ Toolbar        │  │       │  │                │  │</span></span>
<span class="line"><span>│  ├────────────────┤  │       │  │                │  │</span></span>
<span class="line"><span>│  │                │  │  Sync │  │    Canvas      │  │</span></span>
<span class="line"><span>│  │    Canvas      │◄─┼───────┼─►│                │  │</span></span>
<span class="line"><span>│  │                │  │       │  │                │  │</span></span>
<span class="line"><span>│  ├────────────────┤  │       │  │                │  │</span></span>
<span class="line"><span>│  │ Minimap        │  │       │  └────────────────┘  │</span></span>
<span class="line"><span>│  └────────────────┘  │       │                      │</span></span>
<span class="line"><span>└──────────────────────┘       └──────────────────────┘</span></span>
<span class="line"><span>         │                                │</span></span>
<span class="line"><span>         │                                │</span></span>
<span class="line"><span>         └────────────┬───────────────────┘</span></span>
<span class="line"><span>                      │</span></span>
<span class="line"><span>                      ▼</span></span>
<span class="line"><span>              localStorage[&#39;whiteboard-sync&#39;]</span></span>
<span class="line"><span>              (50ms debounced writes)</span></span></code></pre></div><h3 id="synchronization" tabindex="-1">Synchronization <a class="header-anchor" href="#synchronization" aria-label="Permalink to &quot;Synchronization&quot;">​</a></h3><p><strong>File</strong>: <code>client/src/hooks/useWindowSync.ts</code></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Control window (writes)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useEffect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isControlWindow) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> timer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;whiteboard-sync&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fullState));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 50ms debounce</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> clearTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(timer);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, [fullState]);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Presentation window (reads)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useEffect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">isPresentationWindow) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleStorage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StorageEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e.key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;whiteboard-sync&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.newValue) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      setFullState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e.newValue));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;storage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, handleStorage);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">removeEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;storage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, handleStorage);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, []);</span></span></code></pre></div><p><strong>Latency</strong>: &lt;100ms (target), typically &lt;50ms</p><hr><h2 id="security-considerations" tabindex="-1">Security Considerations <a class="header-anchor" href="#security-considerations" aria-label="Permalink to &quot;Security Considerations&quot;">​</a></h2><h3 id="code-execution-sandbox" tabindex="-1">Code Execution Sandbox <a class="header-anchor" href="#code-execution-sandbox" aria-label="Permalink to &quot;Code Execution Sandbox&quot;">​</a></h3><p><strong>Threats</strong>:</p><ul><li>Infinite loops (Fix 1: timeout protection)</li><li>Browser API access (window, document, fetch, etc.)</li><li>localStorage manipulation</li><li>XSS attacks</li></ul><p><strong>Mitigations</strong>:</p><ul><li>Timeout guards in loops (5 second max)</li><li>Limited sandbox APIs (no window, document, fetch)</li><li>Content Security Policy (future)</li><li>User code runs in same origin (can&#39;t be fully sandboxed)</li></ul><p><strong>Known Limitations</strong>:</p><ul><li>Cannot use Web Workers (sandbox needs DOM access)</li><li>User code can still access <code>window</code> via closure</li><li>No true isolation without iframe (degrades UX)</li></ul><h3 id="xss-protection" tabindex="-1">XSS Protection <a class="header-anchor" href="#xss-protection" aria-label="Permalink to &quot;XSS Protection&quot;">​</a></h3><ul><li><strong>D3 output</strong>: Sanitized via DOMPurify before rendering</li><li><strong>LaTeX</strong>: KaTeX has built-in XSS protection</li><li><strong>User text</strong>: React auto-escapes by default</li></ul><hr><h2 id="testing-strategy" tabindex="-1">Testing Strategy <a class="header-anchor" href="#testing-strategy" aria-label="Permalink to &quot;Testing Strategy&quot;">​</a></h2><p>See <a href="./testing.html">Testing Guide</a> for comprehensive test documentation.</p><p><strong>Test Pyramid</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>                /\\</span></span>
<span class="line"><span>               /  \\</span></span>
<span class="line"><span>              /E2E \\            (Future)</span></span>
<span class="line"><span>             /      \\</span></span>
<span class="line"><span>            /────────\\</span></span>
<span class="line"><span>           / Integr.  \\         (44 tests - CodeBlockObject)</span></span>
<span class="line"><span>          /            \\</span></span>
<span class="line"><span>         /──────────────\\</span></span>
<span class="line"><span>        /   Unit Tests   \\      (107 tests - utils, engine)</span></span>
<span class="line"><span>       /                  \\</span></span>
<span class="line"><span>      /────────────────────\\</span></span></code></pre></div><p><strong>Current Coverage</strong>: 148 tests passing, 3 skipped</p><hr><h2 id="deployment" tabindex="-1">Deployment <a class="header-anchor" href="#deployment" aria-label="Permalink to &quot;Deployment&quot;">​</a></h2><h3 id="web-deployment" tabindex="-1">Web Deployment <a class="header-anchor" href="#web-deployment" aria-label="Permalink to &quot;Web Deployment&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> client</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Output: dist/ folder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Deploy to GitHub Pages</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vite base: &#39;/whiteboard/&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Deployed to: https://theghoul21.github.io/whiteboard/</span></span></code></pre></div><h3 id="desktop-deployment" tabindex="-1">Desktop Deployment <a class="header-anchor" href="#desktop-deployment" aria-label="Permalink to &quot;Desktop Deployment&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> client</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tauri:build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Output:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - macOS: client/src-tauri/target/release/bundle/dmg/</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - Windows: client/src-tauri/target/release/bundle/msi/</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - Linux: client/src-tauri/target/release/bundle/deb/</span></span></code></pre></div><h3 id="ci-cd" tabindex="-1">CI/CD <a class="header-anchor" href="#ci-cd" aria-label="Permalink to &quot;CI/CD&quot;">​</a></h3><p>GitHub Actions workflow (<code>.github/workflows/release.yml</code>):</p><ul><li>Triggers on version tags (<code>v*.*.*</code>)</li><li>Builds for macOS, Windows, Linux</li><li>Creates GitHub Release with installers</li></ul><hr><h2 id="future-architecture-improvements" tabindex="-1">Future Architecture Improvements <a class="header-anchor" href="#future-architecture-improvements" aria-label="Permalink to &quot;Future Architecture Improvements&quot;">​</a></h2><h3 id="priority-1-performance" tabindex="-1">Priority 1: Performance <a class="header-anchor" href="#priority-1-performance" aria-label="Permalink to &quot;Priority 1: Performance&quot;">​</a></h3><ul><li>[ ] Viewport culling (only render visible objects)</li><li>[ ] Web Worker execution (requires DOM polyfill)</li><li>[ ] Canvas layer optimization</li><li>[ ] Lazy loading for large boards</li></ul><h3 id="priority-2-scalability" tabindex="-1">Priority 2: Scalability <a class="header-anchor" href="#priority-2-scalability" aria-label="Permalink to &quot;Priority 2: Scalability&quot;">​</a></h3><ul><li>[ ] Backend persistence (PostgreSQL, S3)</li><li>[ ] Real-time collaboration (WebSockets)</li><li>[ ] Version control (Git-like diffing)</li><li>[ ] Cloud sync</li></ul><h3 id="priority-3-security" tabindex="-1">Priority 3: Security <a class="header-anchor" href="#priority-3-security" aria-label="Permalink to &quot;Priority 3: Security&quot;">​</a></h3><ul><li>[ ] Content Security Policy</li><li>[ ] Iframe sandbox isolation</li><li>[ ] Rate limiting for code execution</li><li>[ ] User authentication</li></ul><hr><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">​</a></h2><ul><li><a href="./critical-fixes.html">Critical Fixes</a> - Details on the 4 critical stability fixes</li><li><a href="./testing.html">Testing Guide</a> - Comprehensive test documentation</li><li><a href="./../features/code-blocks.html">Code Blocks</a> - User guide for code execution</li><li><a href="./../features/animations.html">Animations</a> - User guide for animation system</li></ul>`,123)])])}const E=a(e,[["render",l]]);export{c as __pageData,E as default};
